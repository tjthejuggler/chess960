
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess960 First Move Analysis - Interactive Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            overflow-x: hidden;
        }

        .container {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            grid-template-rows: auto 1fr;
            height: 100vh;
            gap: 15px;
            padding: 15px;
        }

        .header {
            grid-column: 1 / -1;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #1e3c72;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .filters {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
        }

        .stats-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        .filter-section {
            margin-bottom: 25px;
        }

        .filter-section h3 {
            color: #1e3c72;
            font-size: 16px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }

        .filter-group {
            margin-bottom: 15px;
        }

        .filter-group label {
            display: block;
            font-size: 13px;
            color: #555;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .filter-group input[type="range"] {
            width: 100%;
            margin: 5px 0;
        }

        .filter-group input[type="checkbox"] {
            margin-right: 8px;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 5px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .checkbox-item:hover {
            background: #f5f5f5;
        }

        .checkbox-item label {
            cursor: pointer;
            flex: 1;
            margin: 0;
        }

        .range-values {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
            margin-top: 3px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .stat-card.active {
            box-shadow: 0 0 0 3px #ffd700;
        }

        .stat-card h4 {
            font-size: 14px;
            margin-bottom: 8px;
            opacity: 0.9;
        }

        .stat-card .value {
            font-size: 24px;
            font-weight: bold;
        }

        .stat-card .subvalue {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }

        .move-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .move-item {
            padding: 10px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid transparent;
        }

        .move-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .move-item.highlighted {
            border-left-color: #667eea;
            background: #e7e9ff;
        }

        .move-item .move-name {
            font-weight: bold;
            color: #1e3c72;
            margin-bottom: 4px;
        }

        .move-item .move-stats {
            font-size: 12px;
            color: #666;
        }

        .dot {
            cursor: pointer;
            transition: all 0.2s;
        }

        .dot:hover {
            stroke: #ffd700;
            stroke-width: 3px;
        }

        .dot.filtered {
            opacity: 0.1;
        }

        .dot.highlighted {
            stroke: #ffd700;
            stroke-width: 3px;
            r: 8;
        }

        .axis-label {
            font-size: 14px;
            font-weight: bold;
            fill: #333;
            cursor: help;
        }

        .axis-tooltip {
            position: absolute;
            background: rgba(30, 60, 114, 0.95);
            color: white;
            padding: 15px;
            border-radius: 8px;
            pointer-events: none;
            font-size: 13px;
            z-index: 1000;
            max-width: 350px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            line-height: 1.6;
        }

        .axis-tooltip strong {
            color: #ffd700;
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px;
            border-radius: 6px;
            pointer-events: none;
            font-size: 13px;
            z-index: 1000;
            max-width: 300px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .tooltip .position-number {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .tooltip .move {
            color: #4fc3f7;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close {
            float: right;
            font-size: 32px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            line-height: 20px;
        }

        .close:hover {
            color: #333;
        }

        .chessboard {
            display: grid;
            grid-template-columns: repeat(8, 50px);
            grid-template-rows: repeat(8, 50px);
            margin: 20px auto;
            border: 3px solid #333;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .square {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            position: relative;
        }

        .square.light {
            background: #f0d9b5;
        }

        .square.dark {
            background: #b58863;
        }

        .square.highlight {
            background: #baca44 !important;
        }

        .square.best-move {
            background: #7fc97f !important;
        }

        .modal-info {
            margin-top: 20px;
        }

        .modal-info h3 {
            color: #1e3c72;
            margin-bottom: 10px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .info-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
        }

        .info-item .label {
            font-size: 12px;
            color: #666;
            margin-bottom: 3px;
        }

        .info-item .value {
            font-weight: bold;
            color: #1e3c72;
        }

        .reset-button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            margin-top: 15px;
            transition: background 0.2s;
        }

        .reset-button:hover {
            background: #c82333;
        }

        .legend {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #333;
        }

        .filter-count {
            text-align: center;
            padding: 10px;
            background: #e7f3ff;
            border-radius: 6px;
            margin-top: 15px;
            font-weight: bold;
            color: #1e3c72;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ôüÔ∏è Chess960 First Move Analysis</h1>
            <p>Interactive visualization of 960 starting positions and their optimal first moves. Click dots to see positions, use filters to explore patterns.</p>
        </div>

        <div class="filters">
            <h2 style="color: #1e3c72; margin-bottom: 20px; font-size: 20px;">Filters</h2>
            
            <div class="filter-section">
                <h3>Pawn Moves by File & Distance</h3>
                <div style="font-size: 12px; color: #666; margin-bottom: 10px;">
                    Single push (e.g., e3) vs Double push (e.g., e4)
                </div>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter-pawn-a3" checked>
                        <label for="filter-pawn-a3">a3 (single)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter-pawn-a4" checked>
                        <label for="filter-pawn-a4">a4 (double)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter-pawn-b3" checked>
                        <label for="filter-pawn-b3">b3 (single)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter-pawn-b4" checked>
                        <label for="filter-pawn-b4">b4 (double)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter-pawn-c3" checked>
                        <label for="filter-pawn-c3">c3 (single)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter-pawn-c4" checked>
                        <label for="filter-pawn-c4">c4 (double)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter-pawn-d3" checked>
                        <label for="filter-pawn-d3">d3 (single)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter-pawn-d4" checked>
                        <label for="filter-pawn-d4">d4 (double)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter-pawn-e3" checked>
                        <label for="filter-pawn-e3">e3 (single)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter-pawn-e4" checked>
                        <label for="filter-pawn-e4">e4 (double)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter-pawn-f3" checked>
                        <label for="filter-pawn-f3">f3 (single)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter-pawn-f4" checked>
                        <label for="filter-pawn-f4">f4 (double)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter-pawn-g3" checked>
                        <label for="filter-pawn-g3">g3 (single)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter-pawn-g4" checked>
                        <label for="filter-pawn-g4">g4 (double)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter-pawn-h3" checked>
                        <label for="filter-pawn-h3">h3 (single)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter-pawn-h4" checked>
                        <label for="filter-pawn-h4">h4 (double)</label>
                    </div>
                </div>
            </div>

            <div class="filter-section">
                <h3>Other Move Types</h3>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter-knight" checked>
                        <label for="filter-knight">Knight Moves</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter-castle" checked>
                        <label for="filter-castle">Castling</label>
                    </div>
                </div>
            </div>

            <div class="filter-section">
                <h3>Evaluation Score</h3>
                <div class="filter-group">
                    <label>Score Range (centipawns)</label>
                    <input type="range" id="score-min" min="-50" max="100" value="-50" step="5">
                    <input type="range" id="score-max" min="-50" max="100" value="100" step="5">
                    <div class="range-values">
                        <span id="score-min-val">-50</span>
                        <span id="score-max-val">+100</span>
                    </div>
                </div>
            </div>

            <div class="filter-section">
                <h3>Pawn Move Details</h3>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter-single-push" checked>
                        <label for="filter-single-push">Single Push (e.g., e3)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter-double-push" checked>
                        <label for="filter-double-push">Double Push (e.g., e4)</label>
                    </div>
                </div>
            </div>

            <div class="filter-section">
                <h3>Piece Behind Pawn</h3>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="behind-queen" checked>
                        <label for="behind-queen">Queen</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="behind-rook" checked>
                        <label for="behind-rook">Rook</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="behind-bishop" checked>
                        <label for="behind-bishop">Bishop</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="behind-knight" checked>
                        <label for="behind-knight">Knight</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="behind-king" checked>
                        <label for="behind-king">King</label>
                    </div>
                </div>
            </div>

            <div class="filter-count" id="filter-count">
                Showing: 960 / 960 positions
            </div>

            <button class="reset-button" onclick="resetFilters()">Reset All Filters</button>
        </div>

        <div class="chart-container">
            <div id="chart"></div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #e53935; opacity: 0.6;"></div>
                    <span>a3</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #e53935;"></div>
                    <span>a4</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #d81b60; opacity: 0.6;"></div>
                    <span>b3</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #d81b60;"></div>
                    <span>b4</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #8e24aa; opacity: 0.6;"></div>
                    <span>c3</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #8e24aa;"></div>
                    <span>c4</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #5e35b1; opacity: 0.6;"></div>
                    <span>d3</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #5e35b1;"></div>
                    <span>d4</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #3949ab; opacity: 0.6;"></div>
                    <span>e3</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #3949ab;"></div>
                    <span>e4</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #1e88e5; opacity: 0.6;"></div>
                    <span>f3</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #1e88e5;"></div>
                    <span>f4</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #00acc1; opacity: 0.6;"></div>
                    <span>g3</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #00acc1;"></div>
                    <span>g4</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #00897b; opacity: 0.6;"></div>
                    <span>h3</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #00897b;"></div>
                    <span>h4</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff9800;"></div>
                    <span>Knight</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #9c27b0;"></div>
                    <span>Castling</span>
                </div>
            </div>
        </div>

        <div class="stats-panel">
            <h2 style="color: #1e3c72; margin-bottom: 20px; font-size: 20px;">Statistics</h2>
            
            <div id="stats-cards"></div>

            <h3 style="color: #1e3c72; margin: 20px 0 10px 0; font-size: 16px;">Top Moves</h3>
            <div class="move-list" id="move-list"></div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 style="color: #1e3c72; margin-bottom: 20px;">Position Details</h2>
            <div id="modal-body"></div>
        </div>
    </div>

    <div class="tooltip" id="tooltip" style="display: none;"></div>
    <div class="axis-tooltip" id="axis-tooltip" style="display: none;"></div>

    <script>
        let data = [];
        let filteredData = [];
        let currentHighlight = null;

        // Load data
        fetch('chess960_best_moves_enhanced.json')
            .then(response => response.json())
            .then(jsonData => {
                data = Object.values(jsonData);
                filteredData = [...data];
                initializeVisualization();
            });

        function initializeVisualization() {
            createChart();
            createStats();
            setupFilters();
            updateFilterCount();
        }

        function createChart() {
            const container = document.getElementById('chart');
            container.innerHTML = '';

            const margin = {top: 40, right: 40, bottom: 60, left: 60};
            const width = Math.max(400, container.clientWidth - margin.left - margin.right);
            const height = Math.max(400, container.clientHeight - margin.top - margin.bottom - 60);

            const svg = d3.select('#chart')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Group by move
            const moveFrequency = d3.rollup(
                filteredData,
                v => v.length,
                d => d.best_move_san
            );

            const moveData = Array.from(moveFrequency, ([move, count]) => ({
                move,
                count,
                positions: filteredData.filter(d => d.best_move_san === move)
            })).sort((a, b) => b.count - a.count);

            // Scales
            const xScale = d3.scaleLinear()
                .domain([0, moveData.length - 1])
                .range([0, width]);

            const yScale = d3.scaleLinear()
                .domain([0, d3.max(moveData, d => d.count)])
                .range([height, 0]);

            // Axes
            svg.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(xScale).ticks(10))
                .selectAll('text')
                .style('font-size', '12px');

            svg.append('g')
                .call(d3.axisLeft(yScale))
                .selectAll('text')
                .style('font-size', '12px');

            // Axis labels with tooltip
            const axisTooltip = d3.select('#axis-tooltip');
            
            svg.append('text')
                .attr('class', 'axis-label')
                .attr('x', width / 2)
                .attr('y', height + 45)
                .attr('text-anchor', 'middle')
                .text('Move Index (sorted by frequency)')
                .on('mouseover', function(event) {
                    axisTooltip
                        .style('display', 'block')
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px')
                        .html(`
                            <strong>üìä What is "Move Index"?</strong>
                            The x-axis represents different first moves, sorted by how frequently they appear as the best move across all 960 Chess960 positions.
                            <br><br>
                            <strong>Left side (low index):</strong> Most common moves (e.g., e4, d4)
                            <br>
                            <strong>Right side (high index):</strong> Rare moves
                            <br><br>
                            Each vertical column of dots represents all positions where that specific move is best.
                        `);
                })
                .on('mouseout', function() {
                    axisTooltip.style('display', 'none');
                });

            svg.append('text')
                .attr('class', 'axis-label')
                .attr('transform', 'rotate(-90)')
                .attr('x', -height / 2)
                .attr('y', -45)
                .attr('text-anchor', 'middle')
                .text('Number of Positions');

            // Create dots for each position
            const allPositions = moveData.flatMap((move, moveIndex) => 
                move.positions.map((pos, posIndex) => ({
                    ...pos,
                    moveIndex,
                    move: move.move,
                    totalCount: move.count,
                    positionInMove: posIndex
                }))
            );

            const tooltip = d3.select('#tooltip');

            svg.selectAll('.dot')
                .data(allPositions)
                .enter()
                .append('circle')
                .attr('class', 'dot')
                .attr('cx', d => xScale(d.moveIndex) + (Math.random() - 0.5) * 20)
                .attr('cy', d => yScale(d.totalCount) + (Math.random() - 0.5) * 10)
                .attr('r', 5)
                .attr('fill', d => getMoveColor(d))
                .attr('opacity', d => getMoveOpacity(d))
                .on('mouseover', function(event, d) {
                    d3.select(this)
                        .attr('r', 8)
                        .attr('opacity', 1);
                    
                    tooltip
                        .style('display', 'block')
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px')
                        .html(`
                            <div class="position-number">Position #${d.position_number}</div>
                            <div><strong>Move:</strong> <span class="move">${d.best_move_san}</span></div>
                            <div><strong>Score:</strong> ${formatScore(d.score)}</div>
                            <div><strong>Piece:</strong> ${d.piece_moved}</div>
                            <div style="margin-top: 5px; font-size: 11px; opacity: 0.8;">Click to see board</div>
                        `);
                })
                .on('mouseout', function() {
                    d3.select(this)
                        .attr('r', 5)
                        .attr('opacity', 0.7);
                    tooltip.style('display', 'none');
                })
                .on('click', (event, d) => showModal(d));
        }

        function getMoveColor(d) {
            if (d.piece_moved === 'Pawn') {
                const file = d.to_square[0]; // Get the file letter (a-h)
                const colors = {
                    'a': '#e53935', // Red
                    'b': '#d81b60', // Pink
                    'c': '#8e24aa', // Purple
                    'd': '#5e35b1', // Deep Purple
                    'e': '#3949ab', // Indigo
                    'f': '#1e88e5', // Blue
                    'g': '#00acc1', // Cyan
                    'h': '#00897b'  // Teal
                };
                return colors[file] || '#999';
            }
            if (d.piece_moved === 'Knight') return '#ff9800';
            if (d.piece_moved === 'King' && d.best_move_san.includes('O')) return '#9c27b0';
            return '#999';
        }

        function getMoveOpacity(d) {
            if (d.piece_moved === 'Pawn') {
                const rank = d.to_square[1];
                const isDoublePush = (rank === '4' || rank === '5');
                return isDoublePush ? 0.9 : 0.5; // Double push = full opacity, single = lighter
            }
            return 0.7;
        }

        function getPawnFileAndDistance(d) {
            if (d.piece_moved === 'Pawn') {
                const file = d.to_square[0];
                const rank = d.to_square[1];
                return `${file}${rank}`; // Returns 'a3', 'e4', etc.
            }
            return null;
        }

        function formatScore(score) {
            const match = score.match(/Cp\(([+-]?\d+)\)/);
            if (match) {
                const cp = parseInt(match[1]);
                return cp > 0 ? `+${cp}` : `${cp}`;
            }
            return score;
        }

        function createStats() {
            const statsContainer = document.getElementById('stats-cards');
            const moveListContainer = document.getElementById('move-list');

            // Calculate statistics
            const totalPositions = filteredData.length;
            
            // Count pawn moves by file and distance
            const pawnMoves = ['a3', 'a4', 'b3', 'b4', 'c3', 'c4', 'd3', 'd4',
                              'e3', 'e4', 'f3', 'f4', 'g3', 'g4', 'h3', 'h4'];
            const pawnStats = {};
            pawnMoves.forEach(move => {
                const file = move[0];
                const rank = move[1];
                pawnStats[move] = filteredData.filter(d =>
                    d.piece_moved === 'Pawn' && d.to_square[0] === file && d.to_square[1] === rank
                ).length;
            });
            
            const knightMoves = filteredData.filter(d => d.piece_moved === 'Knight').length;
            const castling = filteredData.filter(d => d.best_move_san.includes('O')).length;

            const avgScore = d3.mean(filteredData, d => {
                const match = d.score.match(/Cp\(([+-]?\d+)\)/);
                return match ? parseInt(match[1]) : 0;
            });

            // Create stat cards
            const stats = [
                {
                    title: 'Total Positions',
                    value: totalPositions,
                    subvalue: '960 possible',
                    filter: null
                },
                ...pawnMoves.map(move => ({
                    title: move.toUpperCase(),
                    value: pawnStats[move],
                    subvalue: `${(pawnStats[move]/totalPositions*100).toFixed(1)}%`,
                    filter: `pawn-${move}`
                })),
                {
                    title: 'Knight Moves',
                    value: knightMoves,
                    subvalue: `${(knightMoves/totalPositions*100).toFixed(1)}%`,
                    filter: 'knight'
                },
                {
                    title: 'Castling',
                    value: castling,
                    subvalue: `${(castling/totalPositions*100).toFixed(1)}%`,
                    filter: 'castle'
                },
                {
                    title: 'Avg Score',
                    value: avgScore > 0 ? `+${avgScore.toFixed(0)}` : avgScore.toFixed(0),
                    subvalue: 'centipawns',
                    filter: null
                }
            ];

            statsContainer.innerHTML = stats.map(stat => `
                <div class="stat-card" onclick="highlightByType('${stat.filter}')">
                    <h4>${stat.title}</h4>
                    <div class="value">${stat.value}</div>
                    <div class="subvalue">${stat.subvalue}</div>
                </div>
            `).join('');

            // Top moves
            const moveFrequency = d3.rollup(
                filteredData,
                v => v.length,
                d => d.best_move_san
            );

            const topMoves = Array.from(moveFrequency, ([move, count]) => ({
                move,
                count,
                percentage: (count / totalPositions * 100).toFixed(1)
            })).sort((a, b) => b.count - a.count).slice(0, 15);

            moveListContainer.innerHTML = topMoves.map(m => `
                <div class="move-item" onclick="highlightMove('${m.move}')">
                    <div class="move-name">${m.move}</div>
                    <div class="move-stats">${m.count} positions (${m.percentage}%)</div>
                </div>
            `).join('');
        }

        function setupFilters() {
            // Pawn file and distance filters
            const pawnMoves = ['a3', 'a4', 'b3', 'b4', 'c3', 'c4', 'd3', 'd4',
                              'e3', 'e4', 'f3', 'f4', 'g3', 'g4', 'h3', 'h4'];
            pawnMoves.forEach(move => {
                document.getElementById(`filter-pawn-${move}`).addEventListener('change', applyFilters);
            });
            
            // Other move type filters
            ['knight', 'castle'].forEach(type => {
                document.getElementById(`filter-${type}`).addEventListener('change', applyFilters);
            });

            // Score range filters
            const scoreMin = document.getElementById('score-min');
            const scoreMax = document.getElementById('score-max');
            const scoreMinVal = document.getElementById('score-min-val');
            const scoreMaxVal = document.getElementById('score-max-val');

            scoreMin.addEventListener('input', function() {
                scoreMinVal.textContent = this.value > 0 ? `+${this.value}` : this.value;
                applyFilters();
            });

            scoreMax.addEventListener('input', function() {
                scoreMaxVal.textContent = this.value > 0 ? `+${this.value}` : this.value;
                applyFilters();
            });

            // Pawn move details
            ['single-push', 'double-push'].forEach(type => {
                document.getElementById(`filter-${type}`).addEventListener('change', applyFilters);
            });

            // Piece behind pawn
            ['queen', 'rook', 'bishop', 'knight', 'king'].forEach(piece => {
                document.getElementById(`behind-${piece}`).addEventListener('change', applyFilters);
            });
        }

        function applyFilters() {
            filteredData = data.filter(d => {
                // Move type filters
                const isPawn = d.piece_moved === 'Pawn';
                const isKnight = d.piece_moved === 'Knight';
                const isCastle = d.best_move_san.includes('O');

                // Check pawn file and distance filters
                if (isPawn) {
                    const file = d.to_square[0];
                    const rank = d.to_square[1];
                    const move = `${file}${rank}`;
                    if (!document.getElementById(`filter-pawn-${move}`).checked) return false;
                }
                
                if (isKnight && !document.getElementById('filter-knight').checked) return false;
                if (isCastle && !document.getElementById('filter-castle').checked) return false;

                // Score range
                const scoreMatch = d.score.match(/Cp\(([+-]?\d+)\)/);
                if (scoreMatch) {
                    const score = parseInt(scoreMatch[1]);
                    const minScore = parseInt(document.getElementById('score-min').value);
                    const maxScore = parseInt(document.getElementById('score-max').value);
                    if (score < minScore || score > maxScore) return false;
                }

                // Pawn move details
                if (isPawn) {
                    const isSinglePush = d.to_square[1] === '3' || d.to_square[1] === '6';
                    const isDoublePush = d.to_square[1] === '4' || d.to_square[1] === '5';
                    
                    if (isSinglePush && !document.getElementById('filter-single-push').checked) return false;
                    if (isDoublePush && !document.getElementById('filter-double-push').checked) return false;
                }

                // Piece behind pawn
                if (isPawn && d.pieces_behind_pawn && d.pieces_behind_pawn.directly_behind) {
                    const behindPiece = d.pieces_behind_pawn.directly_behind.piece.toLowerCase();
                    if (!document.getElementById(`behind-${behindPiece}`).checked) return false;
                }

                return true;
            });

            createChart();
            createStats();
            updateFilterCount();
        }

        function updateFilterCount() {
            document.getElementById('filter-count').textContent =
                `Showing: ${filteredData.length} / 960 positions`;
        }

        function resetFilters() {
            // Reset all checkboxes
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
            
            // Reset score ranges
            document.getElementById('score-min').value = -50;
            document.getElementById('score-max').value = 100;
            document.getElementById('score-min-val').textContent = '-50';
            document.getElementById('score-max-val').textContent = '+100';
            
            // Clear highlights
            currentHighlight = null;
            document.querySelectorAll('.stat-card').forEach(card => card.classList.remove('active'));
            document.querySelectorAll('.move-item').forEach(item => item.classList.remove('highlighted'));
            
            applyFilters();
        }

        function highlightByType(type) {
            if (!type) return;
            
            // Toggle highlight
            if (currentHighlight === type) {
                currentHighlight = null;
                document.querySelectorAll('.dot').forEach(dot => {
                    dot.classList.remove('highlighted');
                });
                document.querySelectorAll('.stat-card').forEach(card => {
                    card.classList.remove('active');
                });
            } else {
                currentHighlight = type;
                
                // Update stat cards
                document.querySelectorAll('.stat-card').forEach(card => {
                    card.classList.remove('active');
                });
                event.currentTarget.classList.add('active');
                
                // Highlight dots
                const svg = d3.select('#chart svg g');
                svg.selectAll('.dot').each(function(d) {
                    if (!d) return;
                    let matches = false;
                    
                    // Check if it's a pawn file and distance filter
                    if (type.startsWith('pawn-')) {
                        const move = type.split('-')[1]; // e.g., 'a3', 'e4'
                        const file = move[0];
                        const rank = move[1];
                        matches = d.piece_moved === 'Pawn' && d.to_square[0] === file && d.to_square[1] === rank;
                    } else {
                        matches = (
                            (type === 'knight' && d.piece_moved === 'Knight') ||
                            (type === 'castle' && d.best_move_san.includes('O'))
                        );
                    }
                    
                    d3.select(this).classed('highlighted', matches);
                });
            }
        }

        function highlightMove(move) {
            // Toggle highlight
            if (currentHighlight === move) {
                currentHighlight = null;
                document.querySelectorAll('.dot').forEach(dot => {
                    dot.classList.remove('highlighted');
                });
                document.querySelectorAll('.move-item').forEach(item => {
                    item.classList.remove('highlighted');
                });
            } else {
                currentHighlight = move;
                
                // Update move items
                document.querySelectorAll('.move-item').forEach(item => {
                    item.classList.remove('highlighted');
                    if (item.querySelector('.move-name').textContent === move) {
                        item.classList.add('highlighted');
                    }
                });
                
                // Highlight dots
                const svg = d3.select('#chart svg g');
                svg.selectAll('.dot').each(function(d) {
                    if (d && d.best_move_san === move) {
                        d3.select(this).classed('highlighted', true);
                    } else {
                        d3.select(this).classed('highlighted', false);
                    }
                });
            }
        }

        function showModal(position) {
            const modal = document.getElementById('modal');
            const modalBody = document.getElementById('modal-body');
            
            // Create chessboard
            const board = createChessboard(position.fen, position.from_square, position.to_square);
            
            // Create info section
            const info = `
                <div class="modal-info">
                    <h3>Position #${position.position_number}</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="label">Best Move</div>
                            <div class="value">${position.best_move_san}</div>
                        </div>
                        <div class="info-item">
                            <div class="label">Piece Moved</div>
                            <div class="value">${position.piece_moved}</div>
                        </div>
                        <div class="info-item">
                            <div class="label">From Square</div>
                            <div class="value">${position.from_square}</div>
                        </div>
                        <div class="info-item">
                            <div class="label">To Square</div>
                            <div class="value">${position.to_square}</div>
                        </div>
                        <div class="info-item">
                            <div class="label">Evaluation</div>
                            <div class="value">${formatScore(position.score)}</div>
                        </div>
                        <div class="info-item">
                            <div class="label">Piece Order</div>
                            <div class="value">${position.piece_order}</div>
                        </div>
                    </div>
                    ${position.pieces_behind_pawn ? `
                        <div style="margin-top: 15px; padding: 10px; background: #e7f3ff; border-radius: 6px;">
                            <strong>Piece Behind Pawn:</strong> ${position.pieces_behind_pawn.directly_behind.piece} on ${position.pieces_behind_pawn.directly_behind.square}
                        </div>
                    ` : ''}
                    <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; font-family: monospace; font-size: 12px; word-break: break-all;">
                        <strong>FEN:</strong> ${position.fen}
                    </div>
                </div>
            `;
            
            modalBody.innerHTML = board + info;
            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        function createChessboard(fen, fromSquare, toSquare) {
            const pieces = {
                'K': '‚ôî', 'Q': '‚ôï', 'R': '‚ôñ', 'B': '‚ôó', 'N': '‚ôò', 'P': '‚ôô',
                'k': '‚ôö', 'q': '‚ôõ', 'r': '‚ôú', 'b': '‚ôù', 'n': '‚ôû', 'p': '‚ôü'
            };
            
            // Parse FEN
            const fenParts = fen.split(' ');
            const position = fenParts[0];
            const ranks = position.split('/');
            
            let html = '<div class="chessboard">';
            
            for (let rank = 0; rank < 8; rank++) {
                const rankStr = ranks[rank];
                let file = 0;
                
                for (let i = 0; i < rankStr.length; i++) {
                    const char = rankStr[i];
                    
                    if (char >= '1' && char <= '8') {
                        const emptySquares = parseInt(char);
                        for (let j = 0; j < emptySquares; j++) {
                            const square = String.fromCharCode(97 + file) + (8 - rank);
                            const isLight = (rank + file) % 2 === 0;
                            const isHighlight = square === fromSquare;
                            const isBestMove = square === toSquare;
                            
                            html += `<div class="square ${isLight ? 'light' : 'dark'} ${isHighlight ? 'highlight' : ''} ${isBestMove ? 'best-move' : ''}"></div>`;
                            file++;
                        }
                    } else {
                        const square = String.fromCharCode(97 + file) + (8 - rank);
                        const isLight = (rank + file) % 2 === 0;
                        const isHighlight = square === fromSquare;
                        const isBestMove = square === toSquare;
                        
                        html += `<div class="square ${isLight ? 'light' : 'dark'} ${isHighlight ? 'highlight' : ''} ${isBestMove ? 'best-move' : ''}">${pieces[char] || ''}</div>`;
                        file++;
                    }
                }
            }
            
            html += '</div>';
            html += '<div style="text-align: center; margin-top: 10px; font-size: 13px; color: #666;">';
            html += '<span style="background: #baca44; padding: 3px 8px; border-radius: 3px; margin-right: 10px;">From: ' + fromSquare + '</span>';
            html += '<span style="background: #7fc97f; padding: 3px 8px; border-radius: 3px;">To: ' + toSquare + '</span>';
            html += '</div>';
            
            return html;
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Handle window resize
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                if (filteredData.length > 0) {
                    createChart();
                }
            }, 250);
        });
    </script>
</body>
</html>
